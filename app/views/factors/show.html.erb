<div>
  
★結果★<br />
<div id="results" style="width: 100%; height: 200px; border: 1px dotted; padding: 10px; overflow-y: scroll;"></div>
</div>

<%= link_to '一覧へ戻る', '/factors'%>





<script type="text/javascript">
var placesList;

/*
 お店情報取得
*/
window.onload=function getPlaces(){
  
  //結果表示クリア
  document.getElementById("results").innerHTML = "";
  //placesList配列を初期化
  placesList = new Array();
  
  //入力した検索場所を取得
  var addressInput = gon.address;
  if (addressInput == "") {
    return;
  }
  
  //検索場所の位置情報を取得
  var geocoder = new google.maps.Geocoder();
  geocoder.geocode(
    {
      address: addressInput
    },
    function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        //取得した緯度・経度を使って周辺検索
        startNearbySearch(results[0].geometry.location);
      }
      else {
        alert(addressInput + "：位置情報が取得できませんでした。");
      }
    });
}

/*
 位置情報を使って周辺検索
  latLng : 位置座標（google.maps.LatLng）
*/
function startNearbySearch(latLng){
  
  //読み込み中表示
  document.getElementById("results").innerHTML = "Now Loading...";
  
  //Mapインスタンス生成
  var map = new google.maps.Map(
    document.createElement("div")
  );
  
  //PlacesServiceインスタンス生成
  var service = new google.maps.places.PlacesService(map);
  
  //入力したKeywordを取得
  var keywordInput = gon.word;
  
  //周辺検索
  service.nearbySearch(
    {
      location: latLng,
      radius: 5000,
      keyword: keywordInput,
      
    },
    getRoute
  );
}

function getRoute(results,status){

placesList = placesList.concat(results);

for (var i = 0; i < placesList.length; i++) {
    if(placesList[i].rating == undefined){
      placesList[i].rating = -1;
    }
  }


 placesList.sort(function(a,b){
        if(a.rating > b.rating) return -1;
        if(a.rating < b.rating) return 1;
        return 0;
      });

var place = placesList[0];
var name =place.name


var directionsService = new google.maps.DirectionsService();

directionsService.route({
    origin:gon.depature_place,
    destination:gon.destination_place,
    travelMode:gon.transition_method
}, displayResults
);
}

function displayResults(response,status){
console.log(response.routes[0].legs[0].distance.text);
console.log(response.routes[0].legs[0].duration.text);


if(status == google.maps.places.PlacesServiceStatus.OK){
const duration = response.routes[0].legs[0].duration.text;
const distance  = response.routes[0].legs[0].distance.text;

let words = '【出発地】'+gon.depature_place+'\n'+'【目的地】'+gon.destination_place+'\n'+'【所要時間】' + duration + '\n' +
             '【移動距離】　' + distance + '\n';

document.getElementById("results").innerHTML =words

}

}
